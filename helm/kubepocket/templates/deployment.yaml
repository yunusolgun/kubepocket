apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "kubepocket.fullname" . }}
  labels:
    {{- include "kubepocket.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "kubepocket.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "kubepocket.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ include "kubepocket.fullname" . }}-collector

      # PostgreSQL hazÄ±r olana kadar bekle
      initContainers:
      - name: wait-for-postgres
        image: busybox
        command:
        - sh
        - -c
        - |
          until nc -z {{ include "kubepocket.postgresHost" . }} {{ include "kubepocket.postgresPort" . }}; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready!"

      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}

        env:
        - name: DATABASE_URL
          value: "postgresql://{{ include "kubepocket.postgresUser" . }}:{{ include "kubepocket.postgresPassword" . }}@{{ include "kubepocket.postgresHost" . }}:{{ include "kubepocket.postgresPort" . }}/{{ include "kubepocket.postgresDatabase" . }}"
        - name: NAMESPACE
          value: {{ .Values.watchNamespace | default .Release.Namespace }}
        - name: LOG_LEVEL
          value: {{ .Values.logLevel | default "INFO" }}
        - name: CLUSTER_NAME
          value: {{ .Values.clusterName | default "default" }}
        - name: ALLOWED_ORIGINS
          value: {{ .Values.allowedOrigins | default "http://localhost:3000" }}

        ports:
        - name: api
          containerPort: 8000
          protocol: TCP
        - name: metrics
          containerPort: 8001
          protocol: TCP

        livenessProbe:
          httpGet:
            path: /health
            port: api
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: api
          initialDelaySeconds: 5
          periodSeconds: 5

        resources:
          {{- toYaml .Values.resources | nindent 10 }}
